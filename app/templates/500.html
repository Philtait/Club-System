<!-- File: app/templates/errors/500.html -->
{% extends "base.html" %}
{% block title %}Server Error - 500{% endblock %}

{% block extra_head %}
<style>
  .error-container {
    min-height: 60vh;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .error-content {
    text-align: center;
    max-width: 700px;
  }
  .error-code {
    font-size: 8rem;
    font-weight: bold;
    color: #dc3545;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 1rem;
    animation: glitch 2s infinite;
  }
  .error-title {
    font-size: 2.5rem;
    color: #343a40;
    margin-bottom: 1rem;
  }
  .error-message {
    font-size: 1.2rem;
    color: #6c757d;
    margin-bottom: 2rem;
    line-height: 1.6;
  }
  .error-details {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
    text-align: left;
  }
  .status-check {
    background: #e8f5e9;
    border: 1px solid #c8e6c9;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
  }
  .server-icon {
    font-size: 4rem;
    color: #dc3545;
    margin-bottom: 1rem;
    animation: fadeInOut 3s infinite;
  }
  .progress-bar-container {
    margin: 2rem 0;
  }
  .retry-section {
    margin: 2rem 0;
    padding: 1.5rem;
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 8px;
  }
  @keyframes glitch {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-2px); }
    40% { transform: translateX(2px); }
    60% { transform: translateX(-1px); }
    80% { transform: translateX(1px); }
  }
  @keyframes fadeInOut {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
  .action-buttons {
    margin-top: 2rem;
  }
  .action-buttons .btn {
    margin: 0.25rem;
  }
  .loading-dots {
    display: inline-block;
  }
  .loading-dots span {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background-color: #007bff;
    display: inline-block;
    margin: 0 2px;
    animation: loading 1.4s infinite ease-in-out both;
  }
  .loading-dots span:nth-child(1) { animation-delay: -0.32s; }
  .loading-dots span:nth-child(2) { animation-delay: -0.16s; }
  @keyframes loading {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1.0); }
  }
</style>
{% endblock %}

{% block content %}
<div class="error-container">
  <div class="error-content">
    <div class="server-icon">
      <i class="fas fa-server"></i>
    </div>
    <div class="error-code">500</div>
    <h1 class="error-title">Internal Server Error</h1>
    <p class="error-message">
      Oops! Something went wrong on our end. Our servers are experiencing some difficulties, 
      but our technical team has been automatically notified and is working on a fix.
    </p>

    <!-- Server Status Check -->
    <div class="status-check">
      <h6><i class="fas fa-heartbeat me-2"></i>System Status</h6>
      <div class="row text-center">
        <div class="col-md-4">
          <i class="fas fa-database fa-2x text-warning mb-2"></i>
          <p class="small mb-0">Database</p>
          <span class="badge bg-warning">Checking...</span>
        </div>
        <div class="col-md-4">
          <i class="fas fa-cloud fa-2x text-info mb-2"></i>
          <p class="small mb-0">Server</p>
          <span class="badge bg-danger">Error</span>
        </div>
        <div class="col-md-4">
          <i class="fas fa-network-wired fa-2x text-success mb-2"></i>
          <p class="small mb-0">Network</p>
          <span class="badge bg-success">Online</span>
        </div>
      </div>
    </div>

    <!-- Error Details -->
    <div class="error-details">
      <h6><i class="fas fa-info-circle me-2"></i>What Happened?</h6>
      <ul class="mb-0">
        <li>The server encountered an unexpected condition</li>
        <li>A temporary technical issue occurred while processing your request</li>
        <li>This error has been automatically logged and reported to our team</li>
        <li>No data has been lost or compromised</li>
      </ul>
    </div>

    <!-- Auto-retry Section -->
    <div class="retry-section" id="retry-section">
      <h6><i class="fas fa-sync-alt me-2"></i>Automatic Recovery</h6>
      <p class="mb-3">We're attempting to resolve this issue automatically...</p>
      
      <div class="progress-bar-container">
        <div class="progress">
          <div class="progress-bar progress-bar-striped progress-bar-animated" 
               role="progressbar" 
               style="width: 0%" 
               id="retry-progress">
          </div>
        </div>
      </div>
      
      <p class="text-muted small mb-0">
        <span class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </span>
        Retrying in <span id="countdown">30</span> seconds...
      </p>
    </div>

    <!-- Manual Actions -->
    <div class="action-buttons">
      <h5 class="mb-3">What You Can Do:</h5>
      
      <button onclick="reloadPage()" class="btn btn-primary btn-lg" id="reload-btn">
        <i class="fas fa-redo me-2"></i>
        Try Again
      </button>
      
      <a href="{{ url_for('main.index') }}" class="btn btn-success btn-lg">
        <i class="fas fa-home me-2"></i>
        Go Home
      </a>
      
      {% if current_user.is_authenticated %}
        <a href="{{ url_for('dashboard.dashboard') }}" class="btn btn-info btn-lg">
          <i class="fas fa-tachometer-alt me-2"></i>
          Dashboard
        </a>
      {% endif %}
      
      <button onclick="goBack()" class="btn btn-outline-secondary btn-lg">
        <i class="fas fa-arrow-left me-2"></i>
        Go Back
      </button>
    </div>

    <!-- Contact Support -->
    <div class="mt-4 pt-3 border-top">
      <h6>Still Having Issues?</h6>
      <p class="text-muted">
        If this problem persists, please contact our technical support team:
      </p>
      
      <div class="row">
        <div class="col-md-6 mb-2">
          <a href="mailto:support@clubms.com?subject=Server Error 500&body=I encountered a server error while using the Club Management System." 
             class="btn btn-outline-warning btn-block">
            <i class="fas fa-envelope me-2"></i>
            Email Support
          </a>
        </div>
        <div class="col-md-6 mb-2">
          <a href="tel:+254114742348" class="btn btn-outline-info btn-block">
            <i class="fas fa-phone me-2"></i>
            Call +254 114 742 348
          </a>
        </div>
      </div>
      
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let countdownTimer;
let retryCountdown = 30;

function startCountdown() {
  const countdownElement = document.getElementById('countdown');
  const progressBar = document.getElementById('retry-progress');
  
  countdownTimer = setInterval(() => {
    retryCountdown--;
    countdownElement.textContent = retryCountdown;
    
    // Update progress bar
    const progress = ((30 - retryCountdown) / 30) * 100;
    progressBar.style.width = progress + '%';
    
    if (retryCountdown <= 0) {
      clearInterval(countdownTimer);
      reloadPage();
    }
  }, 1000);
}

function reloadPage() {
  const reloadBtn = document.getElementById('reload-btn');
  reloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Reloading...';
  reloadBtn.disabled = true;
  
  // Clear countdown if it's running
  if (countdownTimer) {
    clearInterval(countdownTimer);
  }
  
  // Reload the page
  window.location.reload();
}

function goBack() {
  if (window.history.length > 1) {
    window.history.back();
  } else {
    window.location.href = "{{ url_for('main.index') }}";
  }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
  // Set error timestamp
  document.getElementById('error-timestamp').textContent = new Date().toLocaleString();
  
  // Set user agent
  document.getElementById('user-agent').textContent = navigator.userAgent.split(' ')[0];
  
  // Start countdown timer
  startCountdown();
  
  // Add hover effects
  const buttons = document.querySelectorAll('.btn');
  buttons.forEach(button => {
    button.addEventListener('mouseenter', function() {
      if (!this.disabled) {
        this.style.transform = 'translateY(-2px)';
        this.style.transition = 'transform 0.2s ease';
      }
    });
    
    button.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
  
  // Simulate status checks
  setTimeout(() => {
    document.querySelector('.col-md-4:first-child .badge').className = 'badge bg-success';
    document.querySelector('.col-md-4:first-child .badge').textContent = 'Online';
  }, 3000);
  
  // Check if user wants to disable auto-retry
  document.getElementById('retry-section').addEventListener('click', function(e) {
    if (e.target.closest('h6')) {
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
        document.querySelector('.loading-dots').style.display = 'none';
        document.getElementById('countdown').parentElement.innerHTML = '<em>Auto-retry disabled</em>';
      }
    }
  });
});

// Log error details for debugging (in development)
console.error('500 Internal Server Error occurred at:', window.location.href);
console.error('Timestamp:', new Date().toISOString());
console.error('User Agent:', navigator.userAgent);
</script>
{% endblock %}
